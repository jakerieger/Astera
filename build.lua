---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by jr.
--- DateTime: 12/10/25 8:09 AM
---

-- CMake build script for Lua
-- Usage: lua build.lua [options]

local os_name = package.config:sub(1, 1) == '\\' and 'windows' or 'unix'

-- Configuration
local config = {
    source_dir = ".",
    build_dir = "build",
    build_type = "Release", -- Debug, Release, RelWithDebInfo, MinSizeRel
    generator = nil, -- nil = default, "Ninja", "Unix Makefiles", etc.
    cmake_args = {}, -- Additional CMake arguments
    build_args = {}, -- Additional build arguments
    jobs = 4, -- Number of parallel jobs
    verbose = false
}

-- Parse command line arguments
local function parse_args()
    for i = 1, #arg do
        if arg[i] == "--debug" then
            config.build_type = "Debug"
        elseif arg[i] == "--release" then
            config.build_type = "Release"
        elseif arg[i] == "--clean" then
            config.clean = true
        elseif arg[i] == "--verbose" or arg[i] == "-v" then
            config.verbose = true
        elseif arg[i] == "--jobs" or arg[i] == "-j" then
            config.jobs = tonumber(arg[i + 1]) or config.jobs
        elseif arg[i] == "--generator" or arg[i] == "-G" then
            config.generator = arg[i + 1]
        elseif arg[i] == "--help" or arg[i] == "-h" then
            print("Usage: lua build.lua [options]")
            print("Options:")
            print("  --debug              Build in Debug mode")
            print("  --release            Build in Release mode (default)")
            print("  --clean              Clean build directory before building")
            print("  --verbose, -v        Verbose output")
            print("  --jobs N, -j N       Number of parallel jobs (default: 4)")
            print("  --generator G, -G G  CMake generator")
            print("  --help, -h           Show this help")
            os.exit(0)
        end
    end
end

-- Execute a command and check for errors
local function execute(cmd)
    if config.verbose then
        print("Executing: " .. cmd)
    end

    local result = os.execute(cmd)

    -- Lua 5.1 returns just a number, 5.2+ returns (true/nil, "exit", code)
    local success
    if type(result) == "number" then
        success = (result == 0)
    else
        success = result
    end

    if not success then
        print("Error: Command failed: " .. cmd)
        os.exit(1)
    end

    return success
end

-- Clean build directory
local function clean()
    print("Cleaning build directory...")
    if os_name == "windows" then
        execute('if exist "' .. config.build_dir .. '" rmdir /s /q "' .. config.build_dir .. '"')
    else
        execute('rm -rf "' .. config.build_dir .. '"')
    end
end

-- Create build directory
local function create_build_dir()
    print("Creating build directory...")
    if os_name == "windows" then
        execute('if not exist "' .. config.build_dir .. '" mkdir "' .. config.build_dir .. '"')
    else
        execute('mkdir -p "' .. config.build_dir .. '"')
    end
end

-- Configure CMake
local function configure()
    print("Configuring CMake...")
    print("  Build type: " .. config.build_type)
    print("  Source dir: " .. config.source_dir)
    print("  Build dir: " .. config.build_dir)

    local cmake_cmd = 'cmake'
    cmake_cmd = cmake_cmd .. ' -S "' .. config.source_dir .. '"'
    cmake_cmd = cmake_cmd .. ' -B "' .. config.build_dir .. '"'
    cmake_cmd = cmake_cmd .. ' -DCMAKE_BUILD_TYPE=' .. config.build_type

    if config.generator then
        cmake_cmd = cmake_cmd .. ' -G "' .. config.generator .. '"'
        print("  Generator: " .. config.generator)
    end

    -- Add additional CMake arguments
    for _, arg in ipairs(config.cmake_args) do
        cmake_cmd = cmake_cmd .. ' ' .. arg
    end

    execute(cmake_cmd)
end

-- Build project
local function build()
    print("Building project...")

    local build_cmd = 'cmake --build "' .. config.build_dir .. '"'
    build_cmd = build_cmd .. ' --config ' .. config.build_type
    build_cmd = build_cmd .. ' -j ' .. tostring(config.jobs)

    if config.verbose then
        build_cmd = build_cmd .. ' --verbose'
    end

    -- Add additional build arguments
    for _, arg in ipairs(config.build_args) do
        build_cmd = build_cmd .. ' ' .. arg
    end

    execute(build_cmd)
end

-- Main execution
local function main()
    print("=== CMake Build Script ===")

    parse_args()

    -- Clean if requested
    if config.clean then
        clean()
    end

    -- Create build directory
    create_build_dir()

    -- Configure
    configure()

    -- Build
    build()

    print("=== Build completed successfully! ===")
end

-- Run the script
local status, err = pcall(main)
if not status then
    print("Error: " .. tostring(err))
    os.exit(1)
end